import pyaudio
import wave
import numpy as np
import cv2
import threading
import pyautogui
import sounddevice as sd
import time
import os
import sys

# 录制屏幕
def screen_record(filename, stop_event):
    fourcc = cv2.VideoWriter_fourcc(*'XVID')
    out = cv2.VideoWriter(filename, fourcc, 30.0, (1920, 1080))
    
    while not stop_event.is_set():
        screen = pyautogui.screenshot(region=(0, 0, 1920, 1080))  # 设置录制区域
        frame = np.array(screen)
        frame = cv2.cvtColor(frame, cv2.COLOR_RGB2BGR)
        out.write(frame)
        time.sleep(0.03)  # 保持30帧每秒

    out.release()

# 录制麦克风音频
def record_microphone(filename, stop_event):
    p = pyaudio.PyAudio()
    stream = p.open(format=pyaudio.paInt16, channels=1, rate=44100, input=True, frames_per_buffer=1024)
    
    frames = []
    while not stop_event.is_set():
        data = stream.read(1024)
        frames.append(data)
    
    wf = wave.open(filename, 'wb')
    wf.setnchannels(1)
    wf.setsampwidth(p.get_sample_size(pyaudio.paInt16))
    wf.setframerate(44100)
    wf.writeframes(b''.join(frames))
    wf.close()

# 录制系统音频
def record_system_audio(filename, stop_event):
    fs = 44100  # 采样率
    duration = 10  # 录制时长（秒）

    # 获取所有可用的音频设备
    device_info = sd.query_devices()
    print("可用设备：", device_info)
    device_index = 1  # 假设系统音频设备的索引是1，视实际设备而定

    # 开始录音
    audio_data = sd.rec(int(duration * fs), samplerate=fs, channels=2, dtype='int16', device=device_index)
    sd.wait()

    # 保存音频到文件
    write_wav_file(filename, audio_data, fs)

def write_wav_file(filename, audio_data, fs):
    with wave.open(filename, 'wb') as wf:
        wf.setnchannels(2)
        wf.setsampwidth(2)  # 每个样本占2字节
        wf.setframerate(fs)
        wf.writeframes(audio_data.tobytes())

# 合成音频与视频
def merge_audio_video(audio_file, video_file, output_file):
    command = f'ffmpeg -i {video_file} -i {audio_file} -c:v copy -c:a aac -strict experimental {output_file}'
    os.system(command)

# 停止录制功能
def stop_recording(screen_thread, mic_thread, system_thread, stop_event):
    stop_event.set()
    screen_thread.join()
    mic_thread.join()
    system_thread.join()
    print("录制已停止。")

if __name__ == '__main__':
    stop_event = threading.Event()

    # 启动线程来录制屏幕
    screen_thread = threading.Thread(target=screen_record, args=("output_video.avi", stop_event))
    screen_thread.start()

    # 启动线程来录制麦克风
    mic_thread = threading.Thread(target=record_microphone, args=("microphone_audio.wav", stop_event))
    mic_thread.start()

    # 启动线程来录制系统音频
    system_thread = threading.Thread(target=record_system_audio, args=("system_audio.wav", stop_event))
    system_thread.start()

    print("录制已开始，按 'q' 停止录制...")

    # 等待用户输入停止命令
    while True:
        user_input = input("请输入 'q' 停止录制: ")
        if user_input.lower() == 'q':
            stop_recording(screen_thread, mic_thread, system_thread, stop_event)
            break

    # 合成音频与视频
    print("正在合成音频与视频...")
    merge_audio_video("system_audio.wav", "output_video.avi", "final_output.mp4")
    print("合成完成，文件为 final_output.mp4")
